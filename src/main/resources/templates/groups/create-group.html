<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>

    <!--------- ORIGINAL HEADER ---------->
<!--    <meta charset="UTF-8" />-->
<!--    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">-->
<!--    <link rel="stylesheet" href="custom.css">-->
    <!--------- ORIGINAL HEADER ---------->

        <meta charset="UTF-8">
        <title>Create Group</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
        <!--    <title th:text="${title}"></title>-->
        <!--    <link rel="stylesheet" href="/css/custom.css">-->
        <!--    <link rel="stylesheet" href="/css/activities.css">-->
        <link rel="stylesheet" href="/css/register.css">
        <link href='https://api.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.css' rel='stylesheet' />

</head>
<body>
<nav th:replace="fragments/navbar :: navbar"></nav>
<div class="container">
    <form th:action="@{/groups/create}" th:method="post" th:object="${group}">
        <div class="form-group">
            <label >Group Name</label>
            <input type="text" class="form-control" th:field="*{name}"  name="name" placeholder="">
        </div>
        <div class="form-group">
            <label >Group Description</label>
            <textarea class="form-control" th:field="*{description}" id="post" rows="4" name="description"></textarea>

        </div>

        <div class="row">

            <div class="form-group col-6">
                <label >Add a group member</label>
                <input id="searchUsers" type="text" class="form-control" name="name" placeholder="">
                <ul id="databaseMatches" class="list-group"></ul>

                <!--        <button type="submit" class="btn btn-primary">Submit Post</button>-->
            </div>
            <div class="form-group col-6">
                <label>Current Group Members</label>
                <select class="form-control"  name="groupMembersList" multiple="multiple" id="groupMembersSelectList">
                </select>
                <ul id="groupMembers" class="list-group"></ul>
            </div>
        </div>
        <div class="form-group col-12">
            <img id="imagePreview" src="" alt="" >
            <input type="hidden" id="image"  name="profile_mage" th:field="*{profile_image}" >
            <button type="button" class="btn btn-primary btn-sm" id="addPicture">Group Profile Picture</button>
            <button class="btn btn-primary btn-sm" type="submit">Create Group</button>
        </div>
    </form>
</div>


<script src="//static.filestackapi.com/filestack-js/3.x.x/filestack.min.js"></script>

<script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>

<script src ="/keys.js"></script>
<script src="/js/fileStack.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script th:inline="javascript">
    let searchUsers= document.getElementById("searchUsers");
    let groupMembers=document.getElementById("groupMembers");
    let groupMembersSelectList=document.getElementById("groupMembersSelectList")
    let currentInterval="";

    //this function will search the database for the name being typed in the find a group member input
    // It will return a list of names that can be picked in html.
        function searchDatabaseForUsers(name) {
            console.log("searching for "+name)
            jQuery.ajax({
                'url': `/users.json?name=${name}`,
                success: function (users) {
                    console.log(users);
                    //this will generate the html for the list of names that were found.
                    let html = '';
                    for (let i = 0; i < users.length; i++) {
                        console.log(users[i].lastName);
                        html += '<li class="list-group-item d-flex justify-content-between align-items-center">'+users[i].firstName+" "+users[i].lastName;

                        //will check and see if user is a friend already.
                        if (users[i].friendStatus==="approved") {
                            html += '<button id="addGroupMember' + i + '" class="float-right btn btn-primary btn-sm" type="button">' + 'Add to Group' + '</button>'
                        } else if (users[i].friendStatus==="pending"){
                            html += '<button class="float-right btn btn-warning btn-sm" type="button">Friend Request Pending</button>'
                            html += '<button id="addGroupMember' + i + '" class="float-right btn btn-primary btn-sm" type="button" disabled>' + 'Add to Group' + '</button>'
                        } else{

                        }
                        html+= '</li>'
                    }
                     $('#databaseMatches').html(html);

                    //This will add an event listener to each button, waiting for the name to be picked and added to group
                        for (let i=0; i<users.length; i++){
                            console.log(users[i].firstName + " " + users[i].lastName + " "+  users[i].username + users[i].id)
                        let buttonId="addGroupMember"+i;
                        console.log(buttonId)
                        let addGroupMemberButton=document.getElementById(buttonId);
                        console.log(addGroupMemberButton)
                        addGroupMemberButton.addEventListener("click", ()=>{
                            let html="";
                            html+='<li class="list-group-item d-flex justify-content-between align-items-center">'+users[i].firstName+" "+users[i].lastName+'</li>'
                            groupMembers.innerHTML=groupMembers.innerHTML+html;

                            let newGroupMember=document.createElement("option");
                            newGroupMember.setAttribute("value", users[i].id);
                            newGroupMember.innerText=users[i].firstName+" "+users[i].lastName
                            console.log("about to set field")
                            // newGroupMember.setAttribute("field", [[${newGroupMemberIds}]] )
                            console.log("just set field")
                            newGroupMember.setAttribute("selected", true);
                            groupMembersSelectList.appendChild(newGroupMember);
                        })
                    }



                },
                error: function (data) {
                    console.log(data)
                }
            })
        }

        //this event listener will wait for the user to search for users to add for group, and then will run
        // the searchDatabaseForUsers function.
        searchUsers.addEventListener("keyup", ()=>{
            clearTimeout(currentInterval);
            currentInterval=setTimeout(function(){
                searchDatabaseForUsers(searchUsers.value)
            },500);

        });

</script>

<!--<div th:replace="fragments/footer :: footer"></div>-->
</body>
</html>