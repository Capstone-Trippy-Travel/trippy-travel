<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="custom.css">
</head>
<body>
<form th:action="@{/groups/create}" th:method="post" th:object="${group}">
    <div class="form-group">
        <label >Group Name</label>
        <input type="text" class="form-control" th:field="*{name}"  name="name" placeholder="">
    </div>
    <div class="row">

    <div class="form-group col-6">
        <label >Add a group member</label>
        <input id="searchUsers" type="text" class="form-control" name="name" placeholder="">
        <ul id="databaseMatches" class="list-group"></ul>

<!--        <button type="submit" class="btn btn-primary">Submit Post</button>-->
    </div>
        <div class="col-6">
            <select class="form-control"  name="groupMembersList" multiple="multiple" id="groupMembersSelectList">
            </select>
            <h4>Current Group Members</h4>
            <ul id="groupMembers" class="list-group"></ul>
        </div>
    </div>




    <button type="submit" class="btn btn-primary">Submit Post</button>
</form>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script th:inline="javascript">
    let searchUsers= document.getElementById("searchUsers");
    let groupMembers=document.getElementById("groupMembers");
    let groupMembersSelectList=document.getElementById("groupMembersSelectList")
    let currentInterval="";

    //this function will search the database for the name being typed in the find a group member input
    // It will return a list of names that can be picked in html.
        function searchDatabaseForUsers(name) {
            console.log("searching for "+name)
            jQuery.ajax({
                'url': `/users.json?name=${name}`,
                success: function (users) {

                    //this will generate the html for the list of names that were found.
                    let html = '';
                    for (let i = 0; i < users.length; i++) {
                        console.log(users[i].lastName);
                        html += '<li class="list-group-item d-flex justify-content-between align-items-center">'+users[i].firstName+" "+users[i].lastName;
                        html+= '<button id="addGroupMember'+i+ '" class="float-right btn btn-primary btn-sm" type="button">'+'Add to Group'+'</button>'
                        html+= '</li>'
                    }
                     $('#databaseMatches').html(html);

                    //This will add an event listener to each button, waiting for the name to be picked and added to group
                        for (let i=0; i<users.length; i++){
                            console.log(users[i].firstName + " " + users[i].lastName + " "+  users[i].username + users[i].id)
                        let buttonId="addGroupMember"+i;
                        console.log(buttonId)
                        let addGroupMemberButton=document.getElementById(buttonId);
                        console.log(addGroupMemberButton)
                        addGroupMemberButton.addEventListener("click", ()=>{
                            let html="";
                            html+='<li class="list-group-item d-flex justify-content-between align-items-center">'+users[i].firstName+" "+users[i].lastName+'</li>'
                            groupMembers.innerHTML=groupMembers.innerHTML+html;

                            let newGroupMember=document.createElement("option");
                            newGroupMember.setAttribute("value", users[i].id);
                            newGroupMember.innerText=users[i].firstName+" "+users[i].lastName
                            console.log("about to set field")
                            // newGroupMember.setAttribute("field", [[${newGroupMemberIds}]] )
                            console.log("just set field")
                            newGroupMember.setAttribute("selected", true);
                            groupMembersSelectList.appendChild(newGroupMember);
                        })
                    }



                },
                error: function (data) {
                    console.log(data)
                }
            })
        }

        //this event listener will wait for the user to search for users to add for group, and then will run
        // the searchDatabaseForUsers function.
        searchUsers.addEventListener("keyup", ()=>{
            clearTimeout(currentInterval);
            currentInterval=setTimeout(function(){
                searchDatabaseForUsers(searchUsers.value)
            },500);

        });




</script>
</body>
</html>